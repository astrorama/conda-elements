language: generic

if: branch != master OR tag IS present

matrix:
    include:
        - os: linux
          dist: bionic
        - os: osx
          osx_image: xcode11

before_install:
    # Remove homebrew
    - |
        if [ "$TRAVIS_OS_NAME" = "osx" ]; then
            curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/uninstall > ~/uninstall_homebrew
            chmod +x ~/uninstall_homebrew
            ~/uninstall_homebrew -fq
            rm ~/uninstall_homebrew
        fi

install:
    # Install miniconda
    - |
        MINICONDA_URL="https://repo.continuum.io/miniconda"
        if [ "$TRAVIS_OS_NAME" = "osx" ]; then
            MINICONDA_FILE="Miniconda3-latest-MacOSX-x86_64.sh"
        else
            MINICONDA_FILE="Miniconda3-latest-Linux-x86_64.sh"
        fi
        curl -L -O "${MINICONDA_URL}/${MINICONDA_FILE}"
        bash $MINICONDA_FILE -b

    # Configure conda
    - |
        source $HOME/miniconda3/bin/activate root
        conda config --add channels conda-forge
        conda config --add channels astrorama
        if [ "$TRAVIS_BRANCH" != "master" ]; then
            conda config --add channels astrorama/label/develop
        fi
        conda config --set channel_priority strict
        conda create --yes -n build
        conda activate build
        conda install --yes --quiet conda-build anaconda-client

    # Configure MacOSX SDK
    - |
        if [ "$TRAVIS_OS_NAME" = "osx" ]; then
            echo -e "CONDA_BUILD_SYSROOT:\n    - $(xcrun --sdk macosx --show-sdk-path) # [osx]" > $HOME/conda_build_config.yaml
            cat $HOME/conda_build_config.yaml
        fi

script: |
    if [ -n "$TRAVIS_TAG" ]; then
        LABELS="main"
    elif [ -z "$TRAVIS_PULL_REQUEST_BRANCH" ]; then
        LABELS="$TRAVIS_BRANCH"
    else
        LABELS="pr/$TRAVIS_PULL_REQUEST_BRANCH/$TRAVIS_BRANCH"
    fi
    conda activate build
    conda build --no-force-upload --user astrorama ./recipe --token "$ANACONDA_TOKEN" --label "$LABELS"

